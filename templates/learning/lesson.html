{% extends 'learning/base.html' %}
{% block content %}

{% if user.is_superuser %}
    <a href="{% url 'editlesson' lesson.course lesson.slug %}"><span><button class="btn btn-primary">Edit Lesson</button></span></a>
    <a href="{% url 'deletelesson' lesson.course lesson.slug %}"><span><button class="btn btn-primary">Delete Lesson</button></span></a>
{% endif %}
<!--
<div class="third-theme">
    {{lesson.course}}
    {{lesson.lessonTitle}}
    {% for qa in questionanswer %}
        <br>
        Question: {{qa.question}}
        Answer: {{qa.answer}}<br>
    {% endfor %}
</div>
-->
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script src="https://code.jquery.com/ui/1.8.21/jquery-ui.min.js"></script>
    <script src="jquery.ui.touch-punch.min.js"></script>
    <link rel="stylesheet" href="/resources/demos/style.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">

<style>
    h1, h2, h3{
        color: #f8a300;
    }

    /*a{
        text-decoration: none;
        color: #f8a300;
    }*/

</style>
<div class="col-12 third-theme">
{% autoescape off %}
{{lesson.content}}
{% endautoescape %}
</div>

<div class="col-12">
<div class="card" id="qa-card">
    <div class="card-body text-center">
        {% csrf_token %}
    <form onsubmit="return false">
        <div class="form-group">
            <div class="card-title"><h3>Translate the sentence to English:</h3></div>
            <div style="font-size: 30px;" id="question-label" class="card-body text-center">            
            </div>
            <!--<button id="question-audio" onclick="playAudio()"><i class="fas fa-microphone"></i></button>-->
            <span id='clickableAwesomeFont'><i onclick="playAudio()" style="font-size: 40px;" class="fas fa-volume-up"></i></span>
            <textarea id="answer-textarea" class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
            <button style="margin: 10px;" class="btn" id="btn-submit" onclick="submitAnswer()">Check</button><br>
            <p id="result"></p>
            <!--<button style="margin: 10px;" onclick="goBack()">Go back</button><br>
            <button style="margin: 10px;" onclick="goForward()">Go forward</button><br>-->
            <label id="result"></label>
        </div>
    </form>
    </div>
</div>

<div class="card text-center" id="showend-card">
    <h1>Great job! You did it</h1>
    <a class="secondary-theme" href="{% url 'course' lan %}"><p class="secondary-theme">Return back to {{lesson.course}} lessons</p></a>
</div>

<!--                 -->
<style>
    #container{
  /*width: 300px;*/
  /*display: block;*/
  /*margin: auto;*/
}

#sortable{
  list-style: none;
}

#sortable li{
  margin: 10px;
  cursor: pointer;
  text-align: center;
  display: inline-block;
}



</style>

<div id='container'>
    <h1 id='isRight' class="third-theme"></h1>
    <!--<ul id='list' class="third-theme">-->
        <!--<ul id="sortable" ></ul>-->
    </ul>
  </div>


  <ul id="sortable" ></ul>

  <button style="margin: 10px;" id="btn-bet" onclick="bet()">Check</button><br>

<script>

</script>
<!--                -->
</div>


<!--
{{ questions|json_script:"questions" }}
{{ answers|json_script:"answers" }}

<h1 id="plz">

</h1>

questions:
{{questions}}
<hr>answers
{{answers}}

<h1 id="myq">
</h1>
<h1 id="mya">
</h1>

plzworktest
<h1 id="myqtest">
</h1>
<h1 id="myatest">
</h1>
-->



<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>


<script>





var questionsarray = {{ questions|safe }};
var answersarray = {{ answers|safe }};
var btnSubmit = document.getElementById("btn-submit");
var result = document.getElementById("result");
var questionLabel = document.getElementById("question-label");
var answerTextarea = document.getElementById("answer-textarea");
answerTextarea.addEventListener("keypress", submitOnEnter);
var qaCard = document.getElementById("qa-card");
var showEndCard = document.getElementById("showend-card");
showEndCard.style.display = "none";

var randomNumber = Math.floor(Math.random() * questionsarray.length);
let idle = false;

var gameQuestions = [];
var gameAnswers = [];
var currentIndex = 0;
var currentQuestion = '';
var currentAnswer = '';

for (var q = questionsarray, i = q.length; i--; ) {
    var random = Math.floor(Math.random() * (i + 1));
    var q1 = q.splice(random, 1)[0];
    var a2 = answersarray.splice(random, 1)[0];
    gameQuestions.push(q1);
    gameAnswers.push(a2);
}

console.log('Both arrays:\n' + gameQuestions + '\n' + gameAnswers)
currentQuestion = gameQuestions[currentIndex];
currentAnswer = gameAnswers[currentIndex];
console.log(currentIndex + ' - ' + currentQuestion + ' - ' + currentAnswer);

questionLabel.innerHTML = currentQuestion;

var audioMessage = new SpeechSynthesisUtterance();
var voices = window.speechSynthesis.getVoices();
audioMessage.voice = voices[10]; // Note: some voices don't support altering params
audioMessage.voiceURI = 'native';
audioMessage.volume = 1; // 0 to 1
audioMessage.rate = 0.8; // 0.1 to 10
audioMessage.pitch = 0; //0 to 2
audioMessage.text = currentQuestion;
audioMessage.lang = 'pl';


// add function to remove symbols in testa and testa, such as number or $
// also accept answer if user input is within 2 characters of correct answer
// also accept if user input is within 95% correct ratio of correct answer
function checkIfQAMatch(q, a){
    // remove spaces
    testq = q.replace(/\s+/g, '');
    testa = a.replace(/\s+/g, '');

    // to lowercase
    testq = testq.toLowerCase();
    testa = testa.toLowerCase();
    if (testq === testa) {
        return true;
    }
    else {
        return false;
    }

}

function newRandomQA(){
    currentIndex++;
    currentQuestion = gameQuestions[currentIndex];
    currentAnswer = gameAnswers[currentIndex];
    questionLabel.innerHTML = currentQuestion;
    console.log(currentIndex + ' - ' + currentQuestion + ' - ' + currentAnswer);
    $(answerTextarea).val('');
}

function resetQA() {
    //console.log('finished');
}

function playAudio(){
    audioMessage.text = currentQuestion;
    speechSynthesis.speak(audioMessage);
}

function correctAnswer(){
    idle = true;
    result.innerHTML = "correct";
    $(result).css('color', 'green');
    btnSubmit.innerHTML = "Continue";
    answerTextarea.disabled = true;
    btnSubmit.focus();
}

function wrongAnswerFirst() {
    idle = true;
    result.innerHTML = "incorrect, the correct translation is" + currentAnswer;
    $(result).css('color', 'red');
    btnSubmit.innerHTML = "Continue";
    answerTextarea.disabled = true;
    btnSubmit.focus();
}

function wrongAnswer(){
    gameQuestions.push(gameQuestions.splice(currentIndex, 1)[0]);
    gameAnswers.push(gameAnswers.splice(currentIndex, 1)[0]);
    currentQuestion = gameQuestions[currentIndex];
    currentAnswer = gameAnswers[currentIndex];
    console.log(currentIndex + ' - ' + gameQuestions + ' - ' + gameAnswers);
    questionLabel.innerHTML = currentQuestion;
    console.log(currentIndex + ' - ' + currentQuestion + ' - ' + currentAnswer);
    $(answerTextarea).val('');
}

function playAudio(){
    audioMessage.text = currentQuestion;
    speechSynthesis.speak(audioMessage);
}

function showEndScreen(){
    qaCard.style.display = "none";
    showEndCard.style.display = "block";
}

function submitAnswer(){ 
    if (idle == false) {
        if (checkIfQAMatch(answerTextarea.value, currentAnswer)) {
            if (currentIndex >= gameQuestions.length-1) {
                console.log('finished');
                result.innerHTML = "finished";
                $(result).css('color', 'aqua');
                showEndScreen();
            }
            else {
                correctAnswer();

                //generateDragAndDropGame();
            }   
        }
        else{
            wrongAnswerFirst();

            //generateDragAndDropGame();
        }
    }
    else {
        if (checkIfQAMatch(answerTextarea.value, currentAnswer)) {
            if (currentIndex >= gameQuestions.length-1) {
                console.log('finished');
                result.innerHTML = "finished";
                $(result).css('color', 'aqua');
            }
            else {
                idle = false;
                result.innerHTML = "";
                btnSubmit.innerHTML = "Check";
                newRandomQA();
                answerTextarea.disabled = false;
                answerTextarea.focus();

                //generateDragAndDropGame();
            }  
    }
        else{
            idle = false;
            result.innerHTML = "";
            btnSubmit.innerHTML = "Check";
            wrongAnswer();
            answerTextarea.disabled = false;
            answerTextarea.focus();

            //generateDragAndDropGame();
        }
    }
};

function submitOnEnter(event){
    if(event.which === 13){
        event.target.form.dispatchEvent(new Event("submit", {cancelable: true}));
        event.preventDefault(); // Prevents the addition of a new line in the text field (not needed in a lot of cases)
        submitAnswer();
    }
}




/*
DRAG AND DROP GAME
*/

//generateDragAndDropGame();

//function generateDragAndDropGame() {
    

    var list = document.getElementById('sortable')
    var base, randomized, dragging, draggedOver;
    var isRight = 'Not In Order!';



function bet() {
  console.log("answer: " + mycorrectAnswer.join(""))
  var children = $('#sortable').sortable('refreshPositions').children();
  var bet = '';
  var bet2 = '';
  $.each(children, function() {
    bet2 = bet.concat(bet2, $(this).text().trim());
        console.log($(this).text().trim());
        //console.log(bet2);

    });
    console.log(bet2);
    compare();
}

    const genRandom = (array) => {
    base = array.slice()
    randomized = array.sort(() => Math.random() - 0.5)

    /* Makes it so that the randomized words are not the actual answer */
    if (randomized.join("") !== base.join("")){
        renderItems(randomized)
    } else {
        genRandom(array)
    }

        //renderItems(randomized)

    }

    
    //$( "#draggable" ).draggable({
      //connectToSortable: "#sortable",
      //helper: "clone",
      //revert: "invalid"
    //});
    //$( "ul, li" ).disableSelection();
  

    const renderItems = (data) =>{
    document.getElementById('isRight').innerText = isRight
    list.innerText = ''
    data.forEach(item=>{
        var node = document.createElement("li");    

        //$(node).addClass("ui-state-default");
        node.classList.add('ui-state-default');

        node.draggable = true
        node.style.backgroundColor = item
        node.style.backgroundColor = node.style.backgroundColor.length > 0  
        ? item : 'lightblue'
        node.addEventListener('drag', setDragging) 
        node.addEventListener('dragover', setDraggedOver)
        node.addEventListener('drop', compare) 
        node.innerText = item
        list.appendChild(node)
    })
    }

    const compare = (e) =>{
    /*var index1 = randomized.indexOf(dragging);
    var index2 = randomized.indexOf(draggedOver);
    randomized.splice(index1, 1)
    randomized.splice(index2, 0, dragging)

    isRight = randomized.join("") === base.join("") 
    ? 'In Order!': 'Not In Order!'

    renderItems(randomized)
    };*/
    
    
    var children = $('#sortable').sortable('refreshPositions').children();
  var bet = '';
  var bet2 = '';
  $.each(children, function() {
    bet2 = bet.concat(bet2, $(this).text().trim());
        console.log($(this).text().trim());
        //console.log(bet2);

    });
    console.log(bet2);
  if (bet2 === mycorrectAnswer.join("")){
    console.log("bet");
  }
  else{
    console.log("nobet");
  }

    };


    const setDraggedOver = (e) => {
      e.preventDefault();
      draggedOver = Number.isNaN(parseInt(e.target.innerText)) ? e.target.innerText : parseInt(e.target.innerText)
    }

    const setDragging = (e) =>{
    dragging = Number.isNaN(parseInt(e.target.innerText)) ? e.target.innerText : parseInt(e.target.innerText)
    }

    /*string_to_array = function (currentAnswer) {
        bet =  currentAnswer.trim().split(" ");
        console.log(bet);
        return bet;
    };*/

    sayin = currentAnswer.split(" ")
    console.log(sayin);
    console.log(sayin.join(""))
    mycorrectAnswer = sayin;
    genRandom(currentAnswer.split(" "))
    //genRandom(currentAnswer.split(" "))
    //genRandom(['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'])
    //genRandom(['hello', 'how', 'are', 'you'])
//}

///////////////////////////////






</script>
<script>
// previous working version:
/*
questionsarray = {{ questions|safe }};
var answersarray = {{ answers|safe }};
var result = document.getElementById("result");
var questionLabel = document.getElementById("question-label");
var answerTextarea = document.getElementById("answer-textarea");
//document.getElementById("answer-textarea").addEventListener("keypress", submitOnEnter);
answerTextarea.addEventListener("keypress", submitOnEnter);
var randomNumber = Math.floor(Math.random() * questionsarray.length);

var rollQuestion = questionsarray.splice(randomNumber, 1);
var rollAnswer = answersarray.splice(randomNumber, 1);
var randomQuestion = rollQuestion[ 0 ];
var randomAnswer = rollAnswer[ 0 ];
questionLabel.innerHTML = randomQuestion;
console.log(randomQuestion + ' - ' + randomAnswer);

//audio variables
var audioMessage = new SpeechSynthesisUtterance();
var voices = window.speechSynthesis.getVoices();
audioMessage.voice = voices[10]; // Note: some voices don't support altering params
audioMessage.voiceURI = 'native';
audioMessage.volume = 1; // 0 to 1
audioMessage.rate = 0.8; // 0.1 to 10
audioMessage.pitch = 0; //0 to 2
audioMessage.text = randomQuestion;
audioMessage.lang = 'pl';


var testArray = [1, 2, 3, 4];

function shuffle(o) {
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
};

var testrandom = shuffle(testArray);
console.log(testrandom);

/*audioMessage.onend = function(e) {
console.log('Finished in ' + event.elapsedTime + ' seconds.');
};
speechSynthesis.speak(audioMessage);


function checkIfQAMatch(q, a){
    // remove spaces
    testq = q.replace(/\s+/g, '');
    testa = a.replace(/\s+/g, '');

    // to lowercase
    testq = testq.toLowerCase();
    testa = testa.toLowerCase();
    if (testq === testa) {
        return true;
    }
    else {
        return false;
    }

}

/* go back
var questionIndex = 0;
var listRandomQ = [];
var listRandomA = [];
listRandomQ.push(randomQuestion);
listRandomA.push(randomAnswer);
console.log(listRandomQ + ' - ' + listRandomA);
var previousAnswer;
var previousQuestion;
function goBack(){
    questionIndex--;
    listRandomQ.push(randomQuestion);
    listRandomA.push(randomAnswer);
    randomQuestion = listRandomQ[questionIndex];
    randomAnswer = listRandomA[questionIndex];
    console.log(randomQuestion + ' - ' + randomAnswer);
    questionLabel.innerHTML = randomQuestion;
    $(answerTextarea).val('');

    console.log("back");
}


function goForward(){

}

function newRandomQA(){
    randomNumber = Math.floor(Math.random() * questionsarray.length);

    rollQuestion = questionsarray.splice(randomNumber, 1);
    rollAnswer = answersarray.splice(randomNumber, 1);
    randomQuestion = rollQuestion[ 0 ];
    randomAnswer = rollAnswer[ 0 ];
    console.log(randomQuestion + ' - ' + randomAnswer);
    questionLabel.innerHTML = randomQuestion;
    $(answerTextarea).val('');
    /* go back
    questionIndex++;
    listRandomQ.push(randomQuestion);
    listRandomA.push(randomAnswer);
}

function resetQA() {
    questionsarray = {{ questions|safe }};
    answersarray = {{ answers|safe }};
}


function playAudio(){
    audioMessage.text = randomQuestion;
    speechSynthesis.speak(audioMessage);
}

function submitAnswer(){
    if (checkIfQAMatch(answerTextarea.value, randomAnswer)) { //if (answerTextarea.value === randomAnswer) {
        if (questionsarray.length === 0) {
            resetQA();
            newRandomQA();
        }
        else {
            result.innerHTML = "";
            newRandomQA();
        }        
    }
    else{
        result.innerHTML = "incorrect"
    }
};

function submitOnEnter(event){
    if(event.which === 13){
        event.target.form.dispatchEvent(new Event("submit", {cancelable: true}));
        event.preventDefault(); // Prevents the addition of a new line in the text field (not needed in a lot of cases)
        submitAnswer();
    }
}
*/
</script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
  <script>
$("#sortable").sortable({
  stop: function(ev, ui) {
    //Get the updated positions by calling refreshPositions and then .children on the resulting object.
    var children = $('#sortable').sortable('refreshPositions').children();
    console.log('Positions: ');
    //Loopp through each item in the children array and print out the text.
    $.each(children, function() {
        console.log($(this).text().trim());
    });
  }
});
  </script>
{% endblock %}